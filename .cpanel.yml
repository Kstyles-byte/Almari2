---
deployment:
  tasks:
    - export DEPLOY_ROOT=/home/imsfrkmv/Almari2
    - echo "$(date -u +%FT%TZ) starting deploy to $DEPLOY_ROOT" >> $HOME/deploy.log
    - /bin/mkdir -p $DEPLOY_ROOT
    - if command -v rsync >/dev/null 2>&1; then rsync -a --delete --exclude ".git" --exclude "node_modules" --exclude ".next" --exclude ".github" --exclude "cpanel-deploy.sh" --exclude "build-no-swc.sh" ./ "$DEPLOY_ROOT"/; else find "$DEPLOY_ROOT" -mindepth 1 -maxdepth 1 -not -name ".next" -exec rm -rf {} + || true; /bin/cp -a ./ "$DEPLOY_ROOT"/; fi
    - echo "$(date -u +%FT%TZ) synced repo files" >> $HOME/deploy.log
    - /bin/chmod -R g+w $DEPLOY_ROOT || true
    # Detect npm in cPanel nodevenv (prefer 20, then 18, then highest)
    - if [ -x "$HOME/nodevenv/Almari2/20/bin/npm" ]; then export NPM="$HOME/nodevenv/Almari2/20/bin/npm"; elif [ -x "$HOME/nodevenv/Almari2/18/bin/npm" ]; then export NPM="$HOME/nodevenv/Almari2/18/bin/npm"; else export NPM=$(ls -d "$HOME/nodevenv/Almari2"/*/bin/npm 2>/dev/null | sort -V | tail -n1 || true); fi && if [ -n "$NPM" ] && [ -x "$NPM" ]; then echo "$(date -u +%FT%TZ) resolved npm: $NPM" >> $HOME/deploy.log; else echo "$(date -u +%FT%TZ) resolved npm: not-found" >> $HOME/deploy.log; fi
    - if [ -x "$HOME/nodevenv/Almari2/20/bin/npm" ]; then NPM="$HOME/nodevenv/Almari2/20/bin/npm"; elif [ -x "$HOME/nodevenv/Almari2/18/bin/npm" ]; then NPM="$HOME/nodevenv/Almari2/18/bin/npm"; else NPM=$(ls -d "$HOME/nodevenv/Almari2"/*/bin/npm 2>/dev/null | sort -V | tail -n1 || true); fi && if [ -n "$NPM" ] && [ -x "$NPM" ]; then cd "$DEPLOY_ROOT" && echo "$(date -u +%FT%TZ) installing deps" >> $HOME/deploy.log && if [ -f package-lock.json ]; then "$NPM" ci --no-audit --no-fund --loglevel=error; else "$NPM" install --no-audit --no-fund --loglevel=error; fi && echo "$(date -u +%FT%TZ) building next" >> $HOME/deploy.log && NODE_ENV=production NEXT_TELEMETRY_DISABLED=1 UV_USE_IO_URING=0 CPANEL_BUILD=true DISABLE_MINIFICATION=true NODE_OPTIONS="${NODE_OPTIONS:---max-old-space-size=512}" "$NPM" run build && echo "$(date -u +%FT%TZ) build done" >> $HOME/deploy.log && /bin/mkdir -p "$DEPLOY_ROOT"/logs && /usr/bin/touch "$DEPLOY_ROOT"/.deploy_stamp && echo "$(date -u +%FT%TZ) wrote deploy stamp" >> $HOME/deploy.log; else echo "$(date -u +%FT%TZ) WARN: npm not found under $HOME/nodevenv/Almari2" >> $HOME/deploy.log; fi
    - /bin/mkdir -p $DEPLOY_ROOT/tmp && /usr/bin/touch $DEPLOY_ROOT/tmp/restart.txt && echo "$(date -u +%FT%TZ) restart signaled" >> $HOME/deploy.log
