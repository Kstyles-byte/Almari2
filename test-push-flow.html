<!DOCTYPE html>
<html>
<head>
    <title>Push Notification Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .info { background: #d1ecf1; }
        button { padding: 10px 20px; margin: 5px; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Push Notification Debug Test</h1>
    <p>Open browser console (F12) to see detailed logs</p>
    
    <div id="steps"></div>
    
    <button onclick="runFullTest()">Run Full Test</button>
    <button onclick="runStepByStep()">Run Step by Step</button>
    <button onclick="clearResults()">Clear Results</button>

    <script>
        let stepCounter = 0;

        function addStep(title, content, type = 'info') {
            stepCounter++;
            const stepsDiv = document.getElementById('steps');
            const stepDiv = document.createElement('div');
            stepDiv.className = `step ${type}`;
            stepDiv.innerHTML = `
                <h3>Step ${stepCounter}: ${title}</h3>
                <div>${content}</div>
            `;
            stepsDiv.appendChild(stepDiv);
            return stepDiv;
        }

        function clearResults() {
            document.getElementById('steps').innerHTML = '';
            stepCounter = 0;
        }

        async function runFullTest() {
            clearResults();
            console.log('=== Starting Full Push Notification Test ===');

            try {
                // Step 1: Environment Check
                let step = addStep('Environment Check', 'Checking browser capabilities...');
                const envCheck = {
                    serviceWorker: 'serviceWorker' in navigator,
                    pushManager: 'PushManager' in window,
                    notifications: 'Notification' in window
                };
                
                console.log('Environment check:', envCheck);
                step.innerHTML += `<pre>${JSON.stringify(envCheck, null, 2)}</pre>`;
                
                if (!envCheck.serviceWorker || !envCheck.pushManager || !envCheck.notifications) {
                    addStep('Environment Check Failed', 'Browser does not support push notifications', 'error');
                    return;
                }
                
                step.className = 'step success';

                // Step 2: Permission Check
                step = addStep('Permission Check', 'Checking notification permission...');
                const permission = Notification.permission;
                console.log('Current permission:', permission);
                step.innerHTML += `<div class="status">Permission: ${permission}</div>`;

                if (permission === 'denied') {
                    addStep('Permission Denied', 'Notifications are blocked. Please enable in browser settings and refresh.', 'error');
                    return;
                }

                // Step 3: Request Permission
                if (permission === 'default') {
                    step = addStep('Request Permission', 'Requesting notification permission...');
                    const newPermission = await Notification.requestPermission();
                    console.log('New permission:', newPermission);
                    step.innerHTML += `<div class="status">New Permission: ${newPermission}</div>`;
                    
                    if (newPermission !== 'granted') {
                        addStep('Permission Not Granted', 'User denied permission request', 'error');
                        return;
                    }
                    step.className = 'step success';
                }

                // Step 4: Service Worker Registration
                step = addStep('Service Worker Registration', 'Registering service worker...');
                const registration = await navigator.serviceWorker.register('/sw.js');
                await navigator.serviceWorker.ready;
                console.log('Service worker registered:', registration);
                step.innerHTML += `<div class="status">Registration successful</div>`;
                step.className = 'step success';

                // Step 5: Check Existing Subscription
                step = addStep('Existing Subscription Check', 'Checking for existing subscription...');
                const existingSubscription = await registration.pushManager.getSubscription();
                console.log('Existing subscription:', existingSubscription);
                
                if (existingSubscription) {
                    step.innerHTML += `<div>Found existing subscription</div><pre>Endpoint: ${existingSubscription.endpoint.substring(0, 50)}...</pre>`;
                    console.log('Unsubscribing from existing subscription...');
                    await existingSubscription.unsubscribe();
                    step.innerHTML += `<div>Unsubscribed from existing</div>`;
                } else {
                    step.innerHTML += `<div>No existing subscription found</div>`;
                }
                step.className = 'step success';

                // Step 6: Create New Subscription
                step = addStep('Create New Subscription', 'Creating new push subscription...');
                const vapidKey = 'BMCDlWHwmhqqCk3gtfnMzFwNpDbAP3stR0SL5DofnuIf0Lkt6F9uxBz_x1MDKrjwYqdDqJW6R645IXNw2iZUV38';
                
                function urlBase64ToUint8Array(base64String) {
                    const padding = '='.repeat((4 - base64String.length % 4) % 4);
                    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
                    const rawData = window.atob(base64);
                    const outputArray = new Uint8Array(rawData.length);
                    for (let i = 0; i < rawData.length; ++i) {
                        outputArray[i] = rawData.charCodeAt(i);
                    }
                    return outputArray;
                }

                const applicationServerKey = urlBase64ToUint8Array(vapidKey);
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });

                console.log('New subscription created:', subscription);
                step.innerHTML += `<div class="status">Subscription created successfully</div>`;
                step.innerHTML += `<pre>Endpoint: ${subscription.endpoint.substring(0, 50)}...</pre>`;
                step.className = 'step success';

                // Step 7: Prepare Subscription Data
                step = addStep('Prepare Subscription Data', 'Converting subscription data...');
                const subscriptionData = {
                    subscription: {
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                            auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
                        }
                    }
                };
                
                console.log('Subscription data prepared:', subscriptionData);
                step.innerHTML += `<div class="status">Data conversion successful</div>`;
                step.innerHTML += `<pre>P256DH Key Length: ${subscriptionData.subscription.keys.p256dh.length}\nAuth Key Length: ${subscriptionData.subscription.keys.auth.length}</pre>`;
                step.className = 'step success';

                // Step 8: Save to Database
                step = addStep('Save to Database', 'Calling API to save subscription...');
                console.log('Calling /api/push-subscriptions...');
                
                const response = await fetch('/api/push-subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriptionData)
                });

                const responseText = await response.text();
                console.log('API Response:', response.status, responseText);
                
                step.innerHTML += `<div class="status">Response Status: ${response.status}</div>`;
                step.innerHTML += `<pre>Response: ${responseText}</pre>`;

                if (response.ok) {
                    step.className = 'step success';
                    step.innerHTML += `<div style="color: green; font-weight: bold;">✅ Subscription saved successfully!</div>`;

                    // Step 9: Test Push Notification
                    const testStep = addStep('Test Push Notification', 'Sending test notification...');
                    try {
                        const testResponse = await fetch('/api/test-push', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ message: 'Test from debug script' })
                        });
                        
                        const testResponseText = await testResponse.text();
                        console.log('Test notification response:', testResponse.status, testResponseText);
                        
                        if (testResponse.ok) {
                            testStep.className = 'step success';
                            testStep.innerHTML += `<div style="color: green; font-weight: bold;">✅ Test notification sent!</div>`;
                        } else {
                            testStep.className = 'step error';
                            testStep.innerHTML += `<div>❌ Test failed: ${testResponseText}</div>`;
                        }
                    } catch (err) {
                        testStep.className = 'step error';
                        testStep.innerHTML += `<div>❌ Test error: ${err.message}</div>`;
                    }

                } else {
                    step.className = 'step error';
                    let errorMsg = responseText;
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMsg = JSON.stringify(errorData, null, 2);
                    } catch (e) {}
                    
                    step.innerHTML += `<div style="color: red; font-weight: bold;">❌ Failed to save subscription</div>`;
                    step.innerHTML += `<pre style="color: red;">${errorMsg}</pre>`;
                    
                    // Check if it's an auth error
                    if (response.status === 401) {
                        addStep('Authentication Error', 'User is not logged in. Please log in and try again.', 'error');
                    }
                }

            } catch (error) {
                console.error('Test failed:', error);
                addStep('Test Failed', `❌ Error: ${error.message}<br><pre>${error.stack}</pre>`, 'error');
            }
        }

        async function runStepByStep() {
            alert('Click OK to start step-by-step testing. Check console for detailed logs.');
            await runFullTest();
        }

        // Auto-run test when page loads
        window.addEventListener('load', () => {
            console.log('Push notification debug page loaded. Click "Run Full Test" to start.');
        });
    </script>
</body>
</html>
