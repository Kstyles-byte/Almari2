# name: Deploy Next.js to cPanel

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: '18'

#       - name: Install dependencies
#         run: npm ci

#       - name: Build Next.js app
#         run: npm run build

#       - name: Deploy to cPanel via FTP
#         uses: SamKirkland/FTP-Deploy-Action@v4.3.4
#         with:
#           server: ${{ secrets.CPANEL_FTP_SERVER }}
#           username: ${{ secrets.CPANEL_FTP_USERNAME }}
#           password: ${{ secrets.CPANEL_FTP_PASSWORD }}
#           local-dir: ./
#           server-dir: /home/imsfrkmv/zervia/
#           exclude: |
#             **/.git*
#             **/node_modules/**
#             **/.next/cache/**

#     #   - name: Deploy via SSH
#     #     uses: appleboy/scp-action@v0.1.5
#     #     with:
#     #       host: ${{ secrets.CPANEL_SSH_HOST }}
#     #       username: ${{ secrets.CPANEL_SSH_USER }}
#     #       password: ${{ secrets.CPANEL_SSH_PASSWORD }}
#     #       source: "./"
#     #       target: "/home/imsfrkmv/zervia/"

#     #   - name: Restart Node App
#     #     uses: appleboy/ssh-action@v1.1.0
#     #     with:
#     #       host: ${{ secrets.CPANEL_SSH_HOST }}
#     #       username: ${{ secrets.CPANEL_SSH_USER }}
#     #       password: ${{ secrets.CPANEL_SSH_PASSWORD }}
#     #       script: |
#     #         cd ~/zervia
#     #         npm install --production
#     #         touch tmp/restart.txt




name: Deploy Next.js to cPanel via SSH

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build

      - name: Zip build for deployment
        run: |
          mkdir deploy
          rsync -av --exclude=node_modules --exclude=.git --exclude=.next/cache --exclude=deploy . deploy/
          cd deploy && zip -r ../deploy.zip . && cd ..

      - name: Upload ZIP to cPanel via SSH
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.CPANEL_SSH_HOST }}
          username: ${{ secrets.CPANEL_SSH_USER }}
          password: ${{ secrets.CPANEL_SSH_PASSWORD }}
          port: 1624
          source: "deploy.zip"
          target: "/home/imsfrkmv/zervia/"

      - name: Unzip and Restart App on Server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.CPANEL_SSH_HOST }}
          username: ${{ secrets.CPANEL_SSH_USER }}
          password: ${{ secrets.CPANEL_SSH_PASSWORD }}
          port: 1624
          script: |
            cd ~/zervia
            unzip -o deploy.zip
            rm deploy.zip
            npm install --production --ignore-scripts
            touch tmp/restart.txt || echo "App restarted"
